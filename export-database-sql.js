import { PrismaClient } from '@prisma/client';
import fs from 'fs';
import path from 'path';

const prisma = new PrismaClient();

async function exportDatabaseToSQL() {
  try {
    console.log('üöÄ Starting SQL export...');

    const exportDir = path.join(process.cwd(), 'exports');
    if (!fs.existsSync(exportDir)) {
      fs.mkdirSync(exportDir);
    }

    const sqlPath = path.join(exportDir, 'database_backup.sql');
    let sqlContent = '';

    // Add header
    sqlContent += `-- Database Export - ${new Date().toISOString()}
-- Generated by Prisma Export Script
-- Total records exported: Will be calculated

`;

    // Export Admin data
    console.log('üìä Exporting Admin data...');
    const adminData = await prisma.admin.findMany();
    sqlContent += `-- ADMIN TABLE (${adminData.length} records)\n`;
    adminData.forEach(admin => {
      sqlContent += `INSERT INTO "ADMIN" ("admin_id", "username", "email", "password", "role", "is_active", "created_at", "updated_at") VALUES `;
      sqlContent += `(${admin.adminId}, '${admin.username.replace(/'/g, "''")}', '${admin.email.replace(/'/g, "''")}', '${admin.password.replace(/'/g, "''")}', '${admin.role}', ${admin.isActive}, '${admin.createdAt.toISOString()}', '${admin.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Culture data
    console.log('üìä Exporting Culture data...');
    const cultureData = await prisma.culture.findMany();
    sqlContent += `-- CULTURE TABLE (${cultureData.length} records)\n`;
    cultureData.forEach(culture => {
      sqlContent += `INSERT INTO "CULTURE" ("culture_id", "slug", "nama_budaya", "pulau_asal", "provinsi", "kota_daerah", "klasifikasi", "karakteristik", "status_konservasi", "latitude", "longitude", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${culture.cultureId}, '${culture.slug.replace(/'/g, "''")}', '${culture.namaBudaya.replace(/'/g, "''")}', '${culture.pulauAsal.replace(/'/g, "''")}', '${culture.provinsi.replace(/'/g, "''")}', '${culture.kotaDaerah.replace(/'/g, "''")}', ${culture.klasifikasi ? `'${culture.klasifikasi.replace(/'/g, "''")}'` : 'NULL'}, ${culture.karakteristik ? `'${culture.karakteristik.replace(/'/g, "''")}'` : 'NULL'}, '${culture.statusKonservasi}', ${culture.latitude || 'NULL'}, ${culture.longitude || 'NULL'}, '${culture.status}', '${culture.createdAt.toISOString()}', '${culture.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Subculture data
    console.log('üìä Exporting Subculture data...');
    const subcultureData = await prisma.subculture.findMany();
    sqlContent += `-- SUBCULTURE TABLE (${subcultureData.length} records)\n`;
    subcultureData.forEach(subculture => {
      sqlContent += `INSERT INTO "SUBCULTURE" ("subculture_id", "nama_subkultur", "slug", "salam_khas", "penjelasan", "culture_id", "status", "status_konservasi", "created_at", "updated_at", "arti_salam_khas", "status_priority_display") VALUES `;
      sqlContent += `(${subculture.subcultureId}, '${subculture.namaSubculture.replace(/'/g, "''")}', '${subculture.slug.replace(/'/g, "''")}', '${subculture.salamKhas.replace(/'/g, "''")}', '${subculture.penjelasan.replace(/'/g, "''")}', ${subculture.cultureId}, '${subculture.status}', '${subculture.statusKonservasi}', '${subculture.createdAt.toISOString()}', '${subculture.updatedAt.toISOString()}', ${subculture.artiSalamKhas ? `'${subculture.artiSalamKhas.replace(/'/g, "''")}'` : 'NULL'}, ${subculture.statusPriorityDisplay ? `'${subculture.statusPriorityDisplay}'` : 'NULL'});\n`;
    });
    sqlContent += '\n';

    // Export DomainKodifikasi data
    console.log('üìä Exporting DomainKodifikasi data...');
    const domainData = await prisma.domainKodifikasi.findMany();
    sqlContent += `-- DOMAIN_KODIFIKASI TABLE (${domainData.length} records)\n`;
    domainData.forEach(domain => {
      sqlContent += `INSERT INTO "DOMAIN_KODIFIKASI" ("dk_id", "kode", "nama_domain", "penjelasan", "subculture_id", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${domain.domainKodifikasiId}, '${domain.kode.replace(/'/g, "''")}', '${domain.namaDomain.replace(/'/g, "''")}', '${domain.penjelasan.replace(/'/g, "''")}', ${domain.subcultureId}, '${domain.status}', '${domain.createdAt.toISOString()}', '${domain.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Contributor data
    console.log('üìä Exporting Contributor data...');
    const contributorData = await prisma.contributor.findMany();
    sqlContent += `-- CONTRIBUTOR TABLE (${contributorData.length} records)\n`;
    contributorData.forEach(contributor => {
      sqlContent += `INSERT INTO "CONTRIBUTOR" ("contributor_id", "nama_contributor", "institusi", "email", "expertise_area", "contact_info", "is_coordinator", "status_coordinator", "registered_at", "status_priority_display") VALUES `;
      sqlContent += `(${contributor.contributorId}, '${contributor.namaContributor.replace(/'/g, "''")}', '${contributor.institusi.replace(/'/g, "''")}', '${contributor.email.replace(/'/g, "''")}', '${contributor.expertiseArea.replace(/'/g, "''")}', '${contributor.contactInfo.replace(/'/g, "''")}', ${contributor.isCoordinator}, '${contributor.statusCoordinator}', '${contributor.registeredAt.toISOString()}', ${contributor.statusPriorityDisplay ? `'${contributor.statusPriorityDisplay}'` : 'NULL'});\n`;
    });
    sqlContent += '\n';

    // Export Leksikon data
    console.log('üìä Exporting Leksikon data...');
    const leksikonData = await prisma.leksikon.findMany();
    sqlContent += `-- LEKSIKON TABLE (${leksikonData.length} records)\n`;
    leksikonData.forEach(leksikon => {
      sqlContent += `INSERT INTO "LEKSIKON" ("leksikon_id", "slug", "kata_leksikon", "ipa_international_phonetic_alphabet", "transliterasi", "makna_etimologi", "makna_kultural", "common_meaning", "translation", "varian", "translation_varians", "deskripsi_lain", "dk_id", "status_preservasi", "contributor_id", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${leksikon.leksikonId}, '${leksikon.slug.replace(/'/g, "''")}', '${leksikon.kataLeksikon.replace(/'/g, "''")}', '${leksikon.ipa.replace(/'/g, "''")}', '${leksikon.transliterasi.replace(/'/g, "''")}', '${leksikon.maknaEtimologi.replace(/'/g, "''")}', '${leksikon.maknaKultural.replace(/'/g, "''")}', '${leksikon.commonMeaning.replace(/'/g, "''")}', '${leksikon.translation.replace(/'/g, "''")}', ${leksikon.varian ? `'${leksikon.varian.replace(/'/g, "''")}'` : 'NULL'}, ${leksikon.translationVarians ? `'${leksikon.translationVarians.replace(/'/g, "''")}'` : 'NULL'}, ${leksikon.deskripsiLain ? `'${leksikon.deskripsiLain.replace(/'/g, "''")}'` : 'NULL'}, ${leksikon.domainKodifikasiId}, '${leksikon.statusPreservasi}', ${leksikon.contributorId}, '${leksikon.status}', '${leksikon.createdAt.toISOString()}', '${leksikon.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Asset data
    console.log('üìä Exporting Asset data...');
    const assetData = await prisma.asset.findMany();
    sqlContent += `-- ASSET TABLE (${assetData.length} records)\n`;
    assetData.forEach(asset => {
      sqlContent += `INSERT INTO "ASSET" ("asset_id", "nama_file", "tipe", "penjelasan", "url", "file_size", "hash_checksum", "metadata_json", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${asset.assetId}, '${asset.namaFile.replace(/'/g, "''")}', '${asset.tipe}', ${asset.penjelasan ? `'${asset.penjelasan.replace(/'/g, "''")}'` : 'NULL'}, '${asset.url.replace(/'/g, "''")}', ${asset.fileSize ? `'${asset.fileSize.replace(/'/g, "''")}'` : 'NULL'}, ${asset.hashChecksum ? `'${asset.hashChecksum.replace(/'/g, "''")}'` : 'NULL'}, ${asset.metadataJson ? `'${asset.metadataJson.replace(/'/g, "''")}'` : 'NULL'}, '${asset.status}', '${asset.createdAt.toISOString()}', '${asset.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Referensi data
    console.log('üìä Exporting Referensi data...');
    const referensiData = await prisma.referensi.findMany();
    sqlContent += `-- REFERENSI TABLE (${referensiData.length} records)\n`;
    referensiData.forEach(referensi => {
      sqlContent += `INSERT INTO "REFERENSI" ("referensi_id", "judul", "tipe_referensi", "penjelasan", "url", "penulis", "tahun_terbit", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${referensi.referensiId}, '${referensi.judul.replace(/'/g, "''")}', '${referensi.tipeReferensi}', ${referensi.penjelasan ? `'${referensi.penjelasan.replace(/'/g, "''")}'` : 'NULL'}, ${referensi.url ? `'${referensi.url.replace(/'/g, "''")}'` : 'NULL'}, ${referensi.penulis ? `'${referensi.penulis.replace(/'/g, "''")}'` : 'NULL'}, ${referensi.tahunTerbit ? `'${referensi.tahunTerbit.replace(/'/g, "''")}'` : 'NULL'}, '${referensi.status}', '${referensi.createdAt.toISOString()}', '${referensi.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export junction tables
    console.log('üìä Exporting junction tables...');

    const leksikonAssetsData = await prisma.leksikonAsset.findMany();
    sqlContent += `-- LEKSIKON_ASSETS TABLE (${leksikonAssetsData.length} records)\n`;
    leksikonAssetsData.forEach(item => {
      sqlContent += `INSERT INTO "LEKSIKON_ASSETS" ("leksikon_id", "asset_id", "asset_role", "created_at") VALUES `;
      sqlContent += `(${item.leksikonId}, ${item.assetId}, '${item.assetRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const subcultureAssetsData = await prisma.subcultureAsset.findMany();
    sqlContent += `-- SUBCULTURE_ASSETS TABLE (${subcultureAssetsData.length} records)\n`;
    subcultureAssetsData.forEach(item => {
      sqlContent += `INSERT INTO "SUBCULTURE_ASSETS" ("subculture_id", "asset_id", "asset_role", "created_at") VALUES `;
      sqlContent += `(${item.subcultureId}, ${item.assetId}, '${item.assetRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const cultureAssetsData = await prisma.cultureAsset.findMany();
    sqlContent += `-- CULTURE_ASSETS TABLE (${cultureAssetsData.length} records)\n`;
    cultureAssetsData.forEach(item => {
      sqlContent += `INSERT INTO "CULTURE_ASSETS" ("culture_id", "asset_id", "asset_role", "created_at") VALUES `;
      sqlContent += `(${item.cultureId}, ${item.assetId}, '${item.assetRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const contributorAssetsData = await prisma.contributorAsset.findMany();
    sqlContent += `-- CONTRIBUTOR_ASSETS TABLE (${contributorAssetsData.length} records)\n`;
    contributorAssetsData.forEach(item => {
      sqlContent += `INSERT INTO "CONTRIBUTOR_ASSETS" ("contributor_id", "asset_id", "asset_note", "created_at") VALUES `;
      sqlContent += `(${item.contributorId}, ${item.assetId}, '${item.assetNote}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const leksikonReferensiData = await prisma.leksikonReferensi.findMany();
    sqlContent += `-- LEKSIKON_REFERENSI TABLE (${leksikonReferensiData.length} records)\n`;
    leksikonReferensiData.forEach(item => {
      sqlContent += `INSERT INTO "LEKSIKON_REFERENSI" ("leksikon_id", "referensi_id", "citation_note", "created_at") VALUES `;
      sqlContent += `(${item.leksikonId}, ${item.referensiId}, ${item.citationNote ? `'${item.citationNote}'` : 'NULL'}, '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Write to file
    fs.writeFileSync(sqlPath, sqlContent, 'utf8');

    console.log(`‚úÖ SQL export completed successfully!`);
    console.log(`üìÅ File saved to: ${sqlPath}`);
    console.log(`üìä Total size: ${(sqlContent.length / 1024 / 1024).toFixed(2)} MB`);

  } catch (error) {
    console.error('‚ùå SQL export failed:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Run the SQL export
exportDatabaseToSQL();