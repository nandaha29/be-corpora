import { PrismaClient } from '@prisma/client';
import fs from 'fs';
import path from 'path';

const prisma = new PrismaClient();

async function exportDatabaseToSQL() {
  try {
    console.log('üöÄ Starting SQL export...');

    const exportDir = path.join(process.cwd(), 'exports');
    if (!fs.existsSync(exportDir)) {
      fs.mkdirSync(exportDir);
    }

    const sqlPath = path.join(exportDir, 'database_backup.sql');
    let sqlContent = '';

    // Add header
    sqlContent += `-- Database Export - ${new Date().toISOString()}
-- Generated by Prisma Export Script
-- Total records exported: Will be calculated

`;

    // Export Admin data
    console.log('üìä Exporting Admin data...');
    const adminData = await prisma.admin.findMany();
    sqlContent += `-- ADMIN TABLE (${adminData.length} records)\n`;
    adminData.forEach(admin => {
      sqlContent += `INSERT INTO "ADMIN" ("admin_id", "username", "email", "password", "role", "is_active", "created_at", "updated_at") VALUES `;
      sqlContent += `(${admin.adminId}, '${admin.username.replace(/'/g, "''")}', '${admin.email.replace(/'/g, "''")}', '${admin.password.replace(/'/g, "''")}', '${admin.role}', ${admin.isActive}, '${admin.createdAt.toISOString()}', '${admin.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Culture data
    console.log('üìä Exporting Culture data...');
    const cultureData = await prisma.culture.findMany();
    sqlContent += `-- CULTURE TABLE (${cultureData.length} records)\n`;
    cultureData.forEach(culture => {
      sqlContent += `INSERT INTO "CULTURE" ("culture_id", "slug", "culture_name", "origin_island", "province", "city_region", "classification", "characteristics", "conservation_status", "latitude", "longitude", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${culture.cultureId}, '${culture.slug.replace(/'/g, "''")}', '${culture.cultureName.replace(/'/g, "''")}', '${culture.originIsland.replace(/'/g, "''")}', '${culture.province.replace(/'/g, "''")}', '${culture.cityRegion.replace(/'/g, "''")}', ${culture.classification ? `'${culture.classification.replace(/'/g, "''")}'` : 'NULL'}, ${culture.characteristics ? `'${culture.characteristics.replace(/'/g, "''")}'` : 'NULL'}, '${culture.conservationStatus}', ${culture.latitude || 'NULL'}, ${culture.longitude || 'NULL'}, '${culture.status}', '${culture.createdAt.toISOString()}', '${culture.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Subculture data
    console.log('üìä Exporting Subculture data...');
    const subcultureData = await prisma.subculture.findMany();
    sqlContent += `-- SUBCULTURE TABLE (${subcultureData.length} records)\n`;
    subcultureData.forEach(subculture => {
      sqlContent += `INSERT INTO "SUBCULTURE" ("subculture_id", "slug", "subculture_name", "traditional_greeting", "greeting_meaning", "explanation", "culture_id", "status", "display_priority_status", "conservation_status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${subculture.subcultureId}, '${subculture.slug.replace(/'/g, "''")}', '${subculture.subcultureName.replace(/'/g, "''")}', '${subculture.traditionalGreeting.replace(/'/g, "''")}', ${subculture.greetingMeaning ? `'${subculture.greetingMeaning.replace(/'/g, "''")}'` : 'NULL'}, '${subculture.explanation.replace(/'/g, "''")}', ${subculture.cultureId}, '${subculture.status}', ${subculture.displayPriorityStatus ? `'${subculture.displayPriorityStatus}'` : 'NULL'}, '${subculture.conservationStatus}', '${subculture.createdAt.toISOString()}', '${subculture.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export CodificationDomain data
    console.log('üìä Exporting CodificationDomain data...');
    const domainData = await prisma.codificationDomain.findMany();
    sqlContent += `-- CODIFICATION_DOMAIN TABLE (${domainData.length} records)\n`;
    domainData.forEach(domain => {
      sqlContent += `INSERT INTO "CODIFICATION_DOMAIN" ("domain_id", "code", "domain_name", "explanation", "subculture_id", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${domain.domainId}, '${domain.code.replace(/'/g, "''")}', '${domain.domainName.replace(/'/g, "''")}', '${domain.explanation.replace(/'/g, "''")}', ${domain.subcultureId}, '${domain.status}', '${domain.createdAt.toISOString()}', '${domain.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Contributor data
    console.log('üìä Exporting Contributor data...');
    const contributorData = await prisma.contributor.findMany();
    sqlContent += `-- CONTRIBUTOR TABLE (${contributorData.length} records)\n`;
    contributorData.forEach(contributor => {
      sqlContent += `INSERT INTO "CONTRIBUTOR" ("contributor_id", "contributor_name", "institution", "email", "expertise_area", "contact_info", "display_priority_status", "is_coordinator", "coordinator_status", "registered_at") VALUES `;
      sqlContent += `(${contributor.contributorId}, '${contributor.contributorName.replace(/'/g, "''")}', '${contributor.institution.replace(/'/g, "''")}', '${contributor.email.replace(/'/g, "''")}', '${contributor.expertiseArea.replace(/'/g, "''")}', '${contributor.contactInfo.replace(/'/g, "''")}', ${contributor.displayPriorityStatus ? `'${contributor.displayPriorityStatus}'` : 'NULL'}, ${contributor.isCoordinator}, '${contributor.coordinatorStatus}', '${contributor.registeredAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Lexicon data
    console.log('üìä Exporting Lexicon data...');
    const lexiconData = await prisma.lexicon.findMany();
    sqlContent += `-- LEXICON TABLE (${lexiconData.length} records)\n`;
    lexiconData.forEach(lexicon => {
      sqlContent += `INSERT INTO "LEXICON" ("lexicon_id", "slug", "lexicon_word", "ipa_international_phonetic_alphabet", "transliteration", "etymological_meaning", "cultural_meaning", "common_meaning", "translation", "variant", "variant_translations", "domain_id", "conservation_status", "contributor_id", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${lexicon.lexiconId}, '${lexicon.slug.replace(/'/g, "''")}', '${lexicon.lexiconWord.replace(/'/g, "''")}', ${lexicon.ipaInternationalPhoneticAlphabet ? `'${lexicon.ipaInternationalPhoneticAlphabet.replace(/'/g, "''")}'` : 'NULL'}, '${lexicon.transliteration.replace(/'/g, "''")}', '${lexicon.etymologicalMeaning.replace(/'/g, "''")}', '${lexicon.culturalMeaning.replace(/'/g, "''")}', '${lexicon.commonMeaning.replace(/'/g, "''")}', '${lexicon.translation.replace(/'/g, "''")}', ${lexicon.variant ? `'${lexicon.variant.replace(/'/g, "''")}'` : 'NULL'}, ${lexicon.variantTranslations ? `'${lexicon.variantTranslations.replace(/'/g, "''")}'` : 'NULL'}, ${lexicon.codificationDomainId}, '${lexicon.conservationStatus}', ${lexicon.contributorId}, '${lexicon.status}', '${lexicon.createdAt.toISOString()}', '${lexicon.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Asset data
    console.log('üìä Exporting Asset data...');
    const assetData = await prisma.asset.findMany();
    sqlContent += `-- ASSET TABLE (${assetData.length} records)\n`;
    assetData.forEach(asset => {
      sqlContent += `INSERT INTO "ASSET" ("asset_id", "file_name", "type", "description", "url", "file_size", "hash_checksum", "metadata_json", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${asset.assetId}, '${asset.fileName.replace(/'/g, "''")}', '${asset.type}', ${asset.description ? `'${asset.description.replace(/'/g, "''")}'` : 'NULL'}, '${asset.url.replace(/'/g, "''")}', ${asset.fileSize || 'NULL'}, ${asset.hashChecksum ? `'${asset.hashChecksum.replace(/'/g, "''")}'` : 'NULL'}, ${asset.metadataJson ? `'${asset.metadataJson.replace(/'/g, "''")}'` : 'NULL'}, '${asset.status}', '${asset.createdAt.toISOString()}', '${asset.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export Reference data
    console.log('üìä Exporting Reference data...');
    const referenceData = await prisma.reference.findMany();
    sqlContent += `-- REFERENCE TABLE (${referenceData.length} records)\n`;
    referenceData.forEach(reference => {
      sqlContent += `INSERT INTO "REFERENCE" ("reference_id", "title", "reference_type", "description", "url", "author", "publication_year", "status", "created_at", "updated_at") VALUES `;
      sqlContent += `(${reference.referenceId}, '${reference.title.replace(/'/g, "''")}', '${reference.referenceType}', ${reference.description ? `'${reference.description.replace(/'/g, "''")}'` : 'NULL'}, ${reference.url ? `'${reference.url.replace(/'/g, "''")}'` : 'NULL'}, ${reference.author ? `'${reference.author.replace(/'/g, "''")}'` : 'NULL'}, ${reference.publicationYear ? `'${reference.publicationYear.replace(/'/g, "''")}'` : 'NULL'}, '${reference.status}', '${reference.createdAt.toISOString()}', '${reference.updatedAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Export junction tables
    console.log('üìä Exporting junction tables...');

    const lexiconAssetsData = await prisma.lexiconAsset.findMany();
    sqlContent += `-- LEXICON_ASSETS TABLE (${lexiconAssetsData.length} records)\n`;
    lexiconAssetsData.forEach(item => {
      sqlContent += `INSERT INTO "LEXICON_ASSETS" ("lexicon_id", "asset_id", "asset_role", "created_at") VALUES `;
      sqlContent += `(${item.lexiconId}, ${item.assetId}, '${item.assetRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const subcultureAssetsData = await prisma.subcultureAsset.findMany();
    sqlContent += `-- SUBCULTURE_ASSETS TABLE (${subcultureAssetsData.length} records)\n`;
    subcultureAssetsData.forEach(item => {
      sqlContent += `INSERT INTO "SUBCULTURE_ASSETS" ("subculture_id", "asset_id", "asset_role", "created_at") VALUES `;
      sqlContent += `(${item.subcultureId}, ${item.assetId}, '${item.assetRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const cultureAssetsData = await prisma.cultureAsset.findMany();
    sqlContent += `-- CULTURE_ASSETS TABLE (${cultureAssetsData.length} records)\n`;
    cultureAssetsData.forEach(item => {
      sqlContent += `INSERT INTO "CULTURE_ASSETS" ("culture_id", "asset_id", "asset_role", "created_at") VALUES `;
      sqlContent += `(${item.cultureId}, ${item.assetId}, '${item.assetRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const contributorAssetsData = await prisma.contributorAsset.findMany();
    sqlContent += `-- CONTRIBUTOR_ASSETS TABLE (${contributorAssetsData.length} records)\n`;
    contributorAssetsData.forEach(item => {
      sqlContent += `INSERT INTO "CONTRIBUTOR_ASSETS" ("contributor_id", "asset_id", "asset_note", "created_at") VALUES `;
      sqlContent += `(${item.contributorId}, ${item.assetId}, '${item.assetNote}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const lexiconReferenceData = await prisma.lexiconReference.findMany();
    sqlContent += `-- LEXICON_REFERENCE TABLE (${lexiconReferenceData.length} records)\n`;
    lexiconReferenceData.forEach(item => {
      sqlContent += `INSERT INTO "LEXICON_REFERENCE" ("lexicon_id", "reference_id", "reference_role", "created_at") VALUES `;
      sqlContent += `(${item.lexiconId}, ${item.referenceId}, '${item.referenceRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const subcultureReferenceData = await prisma.subcultureReference.findMany();
    sqlContent += `-- SUBCULTURE_REFERENCE TABLE (${subcultureReferenceData.length} records)\n`;
    subcultureReferenceData.forEach(item => {
      sqlContent += `INSERT INTO "SUBCULTURE_REFERENCE" ("subculture_id", "reference_id", "reference_role", "created_at") VALUES `;
      sqlContent += `(${item.subcultureId}, ${item.referenceId}, '${item.referenceRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    const cultureReferenceData = await prisma.cultureReference.findMany();
    sqlContent += `-- CULTURE_REFERENCE TABLE (${cultureReferenceData.length} records)\n`;
    cultureReferenceData.forEach(item => {
      sqlContent += `INSERT INTO "CULTURE_REFERENCE" ("culture_id", "reference_id", "reference_role", "created_at") VALUES `;
      sqlContent += `(${item.cultureId}, ${item.referenceId}, '${item.referenceRole}', '${item.createdAt.toISOString()}');\n`;
    });
    sqlContent += '\n';

    // Write to file
    fs.writeFileSync(sqlPath, sqlContent, 'utf8');

    console.log(`‚úÖ SQL export completed successfully!`);
    console.log(`üìÅ File saved to: ${sqlPath}`);
    console.log(`üìä Total size: ${(sqlContent.length / 1024 / 1024).toFixed(2)} MB`);

  } catch (error) {
    console.error('‚ùå SQL export failed:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Run the SQL export
exportDatabaseToSQL();